<plan>
  <inputs>
    <param format="%Y-%m-%d" name="start" type="date"/>
    <param format="%Y-%m-%d" name="end" type="date"/>
  </inputs>
  <datasources>
    <db dbname="odw1" host="gpd01.odesk.com" name="odw" password="bestmatch" port="12000" user="bestmatch" vendor="postgres"/>
    <pig amazon_access_token="AKIAJUMIEMJTS4RHPR2A" amazon_token_secret="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" name="pig-script" master_instance_type="c3.4xlarge" slave_instance_type="c3.4xlarge"/>
  </datasources>
  <import>
    <entity datasource="pig-script" name="application">
      <query target="dataset"><![CDATA[
              set default_parallel 20;

              register 's3://odesk-match-staging/pig/lib/elephant-bird-core-4.4.jar';
              register 's3://odesk-match-staging/pig/lib/elephant-bird-pig-4.4.jar';
              register 's3://odesk-match-staging/pig/lib/elephant-bird-hadoop-compat-4.4.jar';

              register 's3://odesk-match-staging/pig/lib/piggybank-0.12.0.jar';

              register 's3://odesk-match-staging/pig/lib/json-simple-1.1.1.jar';

              ja_quick_info_tmp = LOAD 's3://odesk-match-prod/ja_quick_info/2013/03/applied-01.gz' USING com.twitter.elephantbird.pig.load.JsonLoader('-nestedLoad');
              ja_quick_info = FOREACH ja_quick_info_tmp GENERATE 
                    (int) $0#'job_application_id' AS application,
                    (int) $0#'opening_id' as opening,
                    (chararray) $0#'employer'#'op_timezone' AS op_timezone,
                    (chararray) $0#'employer'#'op_country_tz' AS op_country_tz,
                    (int) $0#'employer'#'op_tot_jobs_filled' as op_tot_jobs_filled,
                    (chararray) $0#'employer'#'op_country' AS op_country,

                    (chararray) $0#'contractor'#'dev_is_looking' as dev_is_looking,
                    (chararray) $0#'contractor'#'dev_is_looking_week' as dev_is_looking_week,
                    (chararray) $0#'contractor'#'dev_active_interviews' as dev_active_interviews,
                    (chararray) $0#'contractor'#'dev_availability' as dev_availability,
                    (chararray) $0#'contractor'#'dev_cur_assignments' as dev_cur_assignments,
                    (chararray) $0#'contractor'#'dev_last_worked' as dev_last_worked;

              bestmatch_data = LOAD 's3://odesk-match-staging/pig/bestmatch/bestmatch_data.gz' USING  org.apache.pig.piggybank.storage.CSVExcelStorage(',', 'YES_MULTILINE') AS (made_offer:int, opening:long, opening_title:chararray, opening_description:chararray, opening_skills:chararray, opening_type:chararray, opening_is_hourly:chararray, relatedjobcategory:int, opening_segment:chararray, opening_is_kpo:chararray, opening_category:chararray, opening_subcategory:chararray, opening_budget:double, is_fjp:chararray, pref_cnt:int, application:long, is_ic:chararray, bid_amount:double, bid_rate:double, pref_available_hours:long, pref_english:long, pref_feedback:double, pref_group:long, pref_has_portfolio:chararray, pref_rate_min:double, pref_rate_max:double, pref_region_id, pref_region:chararray, pref_test:double, pref_odesk_hours:double, pref_candidate_type:chararray);

              dataset = JOIN bestmatch_data BY application, ja_quick_info BY application;
              
          ]]></query>
      <field column="bestmatch_data::made_offer" name="made_offer" type="string"/>
      <field column="ja_quick_info::op_timezone" name="employer.op_timezone" type="string"/>
      <field column="ja_quick_info::op_country_tz" name="employer.op_country_tz" type="string"/>
      <field column="ja_quick_info::op_tot_jobs_filled" name="employer.op_tot_jobs_filled" type="string"/>
      <field column="ja_quick_info::op_country" name="employer.country" type="string"/>
      <field column="ja_quick_info::dev_is_looking" name="contractor.dev_is_looking" type="string"/>
      <field column="ja_quick_info::dev_is_looking_week" name="contractor.dev_is_looking_week" type="string"/>
      <field column="ja_quick_info::dev_active_interviews" name="contractor.dev_active_interviews" type="string"/>
      <field column="ja_quick_info::dev_availability" name="contractor.dev_availability" type="string"/>
      <field column="ja_quick_info::dev_cur_assignments" name="contractor.dev_cur_assignments" type="string"/>
      <field column="ja_quick_info::dev_last_worked" name="contractor.dev_last_worked" type="string"/>
      <field column="bestmatch_data::opening" name="opening" type="string"/>
      <field column="bestmatch_data::opening_title" name="opening.title" type="string"/>
      <field column="bestmatch_data::opening_description" name="opening.description" type="string"/>
      <field column="bestmatch_data::application" name="application" type="string"/>
    </entity>
  </import>
</plan>
